<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">變更密碼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="changePasswordForm" method="post" action="/login/">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- 顯示用戶資訊 -->
                    <div class="mb-3">
                        <label class="form-label">用戶帳號</label>
                        <input type="text" class="form-control" value="{{ user.username }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">用戶ID</label>
                        <input type="text" class="form-control" value="{{ user.id }}" readonly>
                    </div>
                    <hr>
                    <!-- 密碼變更表單 -->
                    <div class="mb-3">
                        <label for="old_password" class="form-label">目前密碼</label>
                        <input type="password" class="form-control" id="old_password" name="old_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password1" class="form-label">新密碼</label>
                        <input type="password" class="form-control" id="new_password1" name="new_password1" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password2" class="form-label">確認新密碼</label>
                        <input type="password" class="form-control" id="new_password2" name="new_password2" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">變更密碼</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('changePasswordForm');
    const modal = document.getElementById('changePasswordModal');
    const bsModal = new bootstrap.Modal(modal);
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        fetch('{% url "change_password" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // 顯示對應訊息
            if (data.success) {
                showMessage(data.message, 'success');
                // 延遲1秒後重導向到登入頁面
                setTimeout(() => {
                    window.location.href = '{% url "login" %}';
                }, 1000);
            } else {
                showMessage(data.message, 'danger');
            }
        })
        .catch(error => {
            showMessage('發生錯誤：' + error, 'danger');
        })
        .finally(() => {
            // 不管成功或失敗都執行
            form.reset(); // 清空表單
            bsModal.hide(); // 關閉 Modal
        });
    });
});

// 訊息顯示函數
function showMessage(message, type) {
    const container = document.getElementById('messages-container');
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 mb-2`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
    });
    bsToast.show();
}
</script>