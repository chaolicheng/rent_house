<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>租屋資料分析</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* 主要內容區域樣式 */
        .main-content {
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Unicode MS', 'Microsoft YaHei', sans-serif; /* 兼容不同系統的字體 */
            margin: 20px;
            background-color: #f0f2f5; /* 淺灰色 */
            color: #333;
        }

        /* 圖表區域樣式 */
        .chart-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-image {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
        }

        /* 表單樣式 */
        .form-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .navbar {
            width: 100%;
            margin: 0 auto;
        }
    </style>
</head>
<body class="container-fluid py-5">
    {# 主導覽列 #}
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <div class="me-auto">
                <a href="{% url 'search_database' %}" class="btn btn-info me-2">返回資料庫搜尋</a>
            </div>
            <div>
                {% if user.is_authenticated %}
                    <span class="me-2">歡迎，{{ user.username }}</span>
                    <a href="{% url 'logout' %}" class="btn btn-danger">登出</a>
                {% else %}
                    <a href="{% url 'login' %}" class="btn btn-primary">登入</a>
                {% endif %}
            </div>
        </div>
    </nav>

    {# 主要內容區域 #}
<div class="main-content" id="mainContent">
    <h2 class="mb-4 text-center">租屋資料統計</h2>

    <form method="GET" action="{% url 'data_analysis' %}" class="form-container mb-3 text-center">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <label class="form-label">資料來源</label>
                <select class="form-select" name="data_source" onchange="this.form.submit()">
                    <option value="all_data" {% if selected_data_source == 'all_data' %}selected{% endif %}>全部資料</option>
                    {% if favorites_count >= 2 %}
                        <option value="my_collection" {% if selected_data_source == 'my_collection' %}selected{% endif %}>我的收藏</option>
                    {% endif %}
                </select>
            </div>
        </div>
        <input type="hidden" name="bar_metric" value="{{ bar_metric }}">
        <input type="hidden" name="pie_city" value="{{ pie_city }}">
        <input type="hidden" name="hist_city" value="{{ hist_city }}">
    </form>

    <form method="GET" action="{% url 'data_analysis' %}#barChartSection" class="form-container mb-3 text-center"> {# <-- 這裡修改了 action #}
        <div class="row justify-content-center g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">長條圖指標</label>
                <select class="form-select" name="bar_metric">
                    {% for key, val in bar_metric_map_zh.items %}
                    <option value="{{ key }}" {% if bar_metric == key %}selected{% endif %}>{{ val }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <input type="hidden" name="data_source" value="{{ selected_data_source }}">
                <input type="hidden" name="pie_city" value="{{ pie_city }}">
                <input type="hidden" name="hist_city" value="{{ hist_city }}">
                <button type="submit" class="btn btn-primary w-100">產生長條圖</button>
            </div>
        </div>
    </form>
    <div class="chart-container mb-4 text-center" id="barChartSection"> {# <-- 這裡加上了 id #}
        <h5 class="mb-2">{{ bar_title_zh }}</h5>
        {% if bar_chart %}
            <img src="data:image/png;base64,{{ bar_chart }}" class="chart-image mx-auto d-block" alt="{{ bar_title_zh }}">
        {% else %}
            <div class="alert alert-warning">無足夠資料產生長條圖。</div>
        {% endif %}
    </div>

    <form method="GET" action="{% url 'data_analysis' %}#pieChartSection" class="form-container mb-3 text-center"> {# <-- 這裡修改了 action #}
        <div class="row justify-content-center g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">圓餅圖縣市</label>
                <select class="form-select" name="pie_city">
                    {% for city in chinese_cities %}
                    <option value="{{ city }}" {% if pie_city == city %}selected{% endif %}>{{ city }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <input type="hidden" name="data_source" value="{{ selected_data_source }}">
                <input type="hidden" name="bar_metric" value="{{ bar_metric }}">
                <input type="hidden" name="hist_city" value="{{ hist_city }}">
                <button type="submit" class="btn btn-primary w-100">產生圓餅圖</button>
            </div>
        </div>
    </form>
    <div class="chart-container mb-4 text-center" id="pieChartSection"> {# <-- 這裡加上了 id #}
        <h5 class="mb-2">{{ pie_title_zh }}</h5>
        {% if pie_chart %}
            <img src="data:image/png;base64,{{ pie_chart }}" class="chart-image mx-auto d-block" alt="{{ pie_title_zh }}">
        {% else %}
            <div class="alert alert-warning">無足夠資料產生圓餅圖。</div>
        {% endif %}
    </div>

    <form method="GET" action="{% url 'data_analysis' %}#histChartSection" class="form-container mb-3 text-center"> {# <-- 這裡修改了 action #}
        <div class="row justify-content-center g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">直方圖縣市</label>
                <select class="form-select" name="hist_city">
                    {% for city in chinese_cities %}
                    <option value="{{ city }}" {% if hist_city == city %}selected{% endif %}>{{ city }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <input type="hidden" name="data_source" value="{{ selected_data_source }}">
                <input type="hidden" name="bar_metric" value="{{ bar_metric }}">
                <input type="hidden" name="pie_city" value="{{ pie_city }}">
                <button type="submit" class="btn btn-primary w-100">產生直方圖</button>
            </div>
        </div>
    </form>
    <div class="chart-container mb-4 text-center" id="histChartSection"> {# <-- 這裡加上了 id #}
        <h5 class="mb-2">{{ hist_title_zh }}</h5>
        {% if hist_chart %}
            <img src="data:image/png;base64,{{ hist_chart }}" class="chart-image mx-auto d-block" alt="{{ hist_title_zh }}">
        {% else %}
            <div class="alert alert-warning">無足夠資料產生直方圖。</div>
        {% endif %}
    </div>
</div>

    {# JavaScript #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 這裡不需要額外的 JavaScript，瀏覽器會自動處理錨點滾動
    </script>
</body>
</html>